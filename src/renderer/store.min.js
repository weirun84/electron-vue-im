import Vue from"vue";import Vuex from"vuex";import router from"./router";var clientiot=require("clientiot"),co=require("co"),allfriend;Vue.use(Vuex),localStorage.getItem("allFriend")?allfriend=JSON.parse(localStorage.getItem("allFriend")):co(function*(){var allpepeo=JSON.parse(yield clientiot.employees.getEmployees());console.log(allpepeo),allfriend=allpepeo.data,localStorage.setItem("allFriend",JSON.stringify(allfriend))});const now=new Date,state={searchText:"",user:{name:"ratel",img:"static/images/UserAvatar.jpg"},chatlist:[{id:1,user:{name:"产品经理",img:"static/images/mother.jpg"},messages:[{content:"么么哒，妈咪爱你",date:now},{content:"按回车可以发送信息，还可以给我发送表情哟",date:now}],index:1},{id:2,user:{name:"项目经理",img:"static/images/father.jpg"},messages:[{content:"Are you kidding me?",date:now}],index:2},{id:3,user:{name:"机器人",img:"static/images/vue.jpg"},messages:[{content:"static/images/vue.jpg",date:now}],index:3}],friendlist:allfriend,emojis:[{file:"100.gif",code:"/::)",title:"微笑",reg:/\/::\)/g},{file:"101.gif",code:"/::~",title:"伤心",reg:/\/::~/g},{file:"102.gif",code:"/::B",title:"美女",reg:/\/::B/g},{file:"103.gif",code:"/::|",title:"发呆",reg:/\/::\|/g},{file:"104.gif",code:"/:8-)",title:"墨镜",reg:/\/:8-\)/g},{file:"105.gif",code:"/::<",title:"哭",reg:/\/::</g},{file:"106.gif",code:"/::$",title:"羞",reg:/\/::\$/g},{file:"107.gif",code:"/::X",title:"哑",reg:/\/::X/g},{file:"108.gif",code:"/::Z",title:"睡",reg:/\/::Z/g},{file:"109.gif",code:"/::'(",title:"哭",reg:/\/::'\(/g},{file:"110.gif",code:"/::-|",title:"囧",reg:/\/::-\|/g},{file:"111.gif",code:"/::@",title:"怒",reg:/\/::@/g},{file:"112.gif",code:"/::P",title:"调皮",reg:/\/::P/g},{file:"113.gif",code:"/::D",title:"笑",reg:/\/::D/g},{file:"114.gif",code:"/::O",title:"惊讶",reg:/\/::O/g},{file:"115.gif",code:"/::(",title:"难过",reg:/\/::\(/g},{file:"116.gif",code:"/::+",title:"酷",reg:/\/::\+/g},{file:"117.gif",code:"/:--b",title:"汗",reg:/\/:--b/g},{file:"118.gif",code:"/::Q",title:"抓狂",reg:/\/::Q/g},{file:"119.gif",code:"/::T",title:"吐",reg:/\/::T/g},{file:"120.gif",code:"/:,@P",title:"笑",reg:/\/:,@P/g},{file:"121.gif",code:"/:,@-D",title:"快乐",reg:/\/:,@-D/g},{file:"122.gif",code:"/::d",title:"奇",reg:/\/::d/g},{file:"123.gif",code:"/:,@o",title:"傲",reg:/\/:,@o/g},{file:"124.gif",code:"/::g",title:"饿",reg:/\/::g/g},{file:"125.gif",code:"/:|-)",title:"累",reg:/\/:\|-\)/g},{file:"126.gif",code:"/::!",title:"吓",reg:/\/::!/g},{file:"127.gif",code:"/::L",title:"汗",reg:/\/::L/g},{file:"128.gif",code:"/::>",title:"高兴",reg:/\/::>/g},{file:"129.gif",code:"/::,@",title:"闲",reg:/\/::,@/g},{file:"130.gif",code:"/:,@f",title:"努力",reg:/\/:,@f/g},{file:"131.gif",code:"/::-S",title:"骂",reg:/\/::-S/g},{file:"133.gif",code:"/:,@x",title:"秘密",reg:/\/:,@x/g},{file:"134.gif",code:"/:,@@",title:"乱",reg:/\/:,@@/g},{file:"135.gif",code:"/::8",title:"疯",reg:/\/::8/g},{file:"136.gif",code:"/:,@!",title:"哀",reg:/\/:,@!/g},{file:"137.gif",code:"/:!!!",title:"鬼",reg:/\/:!!!/g},{file:"138.gif",code:"/:xx",title:"打击",reg:/\/:xx/g},{file:"139.gif",code:"/:bye",title:"bye",reg:/\/:bye/g},{file:"142.gif",code:"/:handclap",title:"鼓掌",reg:/\/:handclap/g},{file:"145.gif",code:"/:<@",title:"什么",reg:/\/:<@/g},{file:"147.gif",code:"/::-O",title:"累",reg:/\/::-O/g},{file:"153.gif",code:"/:@x",title:"吓",reg:/\/:@x/g},{file:"155.gif",code:"/:pd",title:"刀",reg:/\/:pd/g},{file:"156.gif",code:"/:<W>",title:"水果",reg:/\/:<W>/g},{file:"157.gif",code:"/:beer",title:"酒",reg:/\/:beer/g},{file:"158.gif",code:"/:basketb",title:"篮球",reg:/\/:basketb/g},{file:"159.gif",code:"/:oo",title:"乒乓",reg:/\/:oo/g},{file:"195.gif",code:"/:circle",title:"跳舞",reg:/\/:circle/g},{file:"160.gif",code:"/:coffee",title:"咖啡",reg:/\/:coffee/g}],selectId:1,selectFriendId:0},mutations={initData(state){let data=localStorage.getItem("vue-chat");data&&(state.chatlist=JSON.parse(data))},search(state,value){state.searchText=value},userInfo(state,value){state.user=value,console.log("用户信息："+JSON.parse(value))},selectSession(state,value){state.selectId=value},selectFriend(state,value){state.selectFriendId=value},newUerName(state,value){state.uerName=value},sendMessage(state,msg){let result=state.chatlist.find(session=>session.id===state.selectId);result.messages.push({content:msg.content,date:new Date,self:!0}),"机器人"===result.user.name&&setTimeout(()=>{result.messages.push({content:msg.reply,date:new Date,self:!1})},500)},send(state){let result=state.friendlist.find(friend=>parseInt(friend.data.hrguid)===state.selectFriendId),msg=state.chatlist.find(msg=>msg.user.name===result.remark);if(msg)state.selectId=msg.index,router.push({path:"/chat"});else{state.selectId=1;for(let i=0;i<state.chatlist.length;i++)state.chatlist[i].id++,state.chatlist[i].index++;state.chatlist.unshift({id:1,user:{name:result.remark,img:result.img},messages:[{content:"已经置顶聊天，可以给我发信息啦！",date:new Date}],index:1})}}},getters={searchedChatlist(state){let sessions;return state.chatlist.filter(sessions=>sessions.user.name.includes(state.searchText))},searchedFriendlist(state){let friends;return state.friendlist.filter(friends=>friends.fullname.includes(state.searchText))},selectedChat(state){let session;return state.chatlist.find(session=>session.id===state.selectId)},selectedFriend(state){let friend;return state.friendlist.find(friend=>parseInt(friend.data.hrguid)===state.selectFriendId)},messages(state){let session;return state.chatlist.find(session=>session.id===state.selectId).messages},setGroups(state){let friend;return state.partlist.find(session=>session.id===state.selectId)}},actions={search:({commit:commit},value)=>{setTimeout(()=>{commit("search",value)},100)},userInfo:({commit:commit},value)=>value,selectSession:({commit:commit},value)=>commit("selectSession",value),selectFriend:({commit:commit},value)=>commit("selectFriend",value),sendMessage:({commit:commit},msg)=>commit("sendMessage",msg),send:({commit:commit})=>commit("send"),initData:({commit:commit})=>commit("initData"),setGroup:({commit:commit},value)=>commit("setGroup",value)},store=new Vuex.Store({state:state,mutations:mutations,getters:getters,actions:actions});co(function*(){clientiot.globalinfo.regPrivateThingName(1002,function(topic,res){console.log(topic);var rest=JSON.parse(res);console.log(rest),state.chatlist[0].messages.push({content:rest.msgContent.text,date:now})})}),store.watch(state=>state.chatlist,val=>{localStorage.setItem("vue-chat",JSON.stringify(val))},{deep:!0});export default store;