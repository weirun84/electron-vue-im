function getQueryStringByUrl(url,name){if(url!=null){var myUrl=url.substring(url.indexOf("?")+1);var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=myUrl.match(reg);if(r!=null){if(r[2]!=""){return decodeURIComponent(r[2]);}}}
return null;};sclickUrl="http://item.taobao.com/item.htm?id=";quanDetailUrl="https://market.m.taobao.com/apps/aliyx/coupon/detail.html";qdclickUrl="https://item.jd.com/";isShow=false;chrome.storage.local.get(['shopConfig'],function(valueArray){if(valueArray.shopConfig!=undefined){var shopConfigJson=eval("("+valueArray.shopConfig+")");if(shopConfigJson.sclickUrl!=undefined){sclickUrl=shopConfigJson.sclickUrl;isShow=true;}
if(shopConfigJson.quanDetailUrl!=undefined){quanDetailUrl=shopConfigJson.quanDetailUrl;}
if(shopConfigJson.qdclickUrl!=undefined){qdclickUrl=shopConfigJson.qdclickUrl;}}});function getQuanArrayStr2(element,itemid,sellerId,uniqpid,title){element.find(".lxRateImgParent").prepend('<div class="lxtbctip" style="position: absolute; top: -19px;width: 99.5%;border-bottom:none;display:block;text-align: center;"></div>');if(uniqpid!=null&&uniqpid!=""){var similarUrl="https://s.taobao.com/search?type=samestyle&app=i2i&rec_type=1&uniqpid="+uniqpid+"&nid="+itemid+"&sort=sale-desc";chrome.extension.sendRequest({type:'weburl',dataType:"text",url:similarUrl},function(response){var beginCut=response.data.indexOf("g_page_config")+16;var endCut=response.data.indexOf("g_srp_loadCss();");if(beginCut>0){try{var similarListStr=response.data.substring(beginCut,endCut).trim();similarListStr=similarListStr.substring(0,similarListStr.length-1);var similarJson=JSON.parse(similarListStr);var similarList=similarJson.mods.recitem.data.items;if(similarList.length>0){similarList.sort(function(a,b){return a.view_price-b.view_price});var thisBean=similarList[0];element.find(".lxtbctip").prepend('<a target="_blank" class="lxtbctip_similar" href="javascript:void(0);" data_url="'+sclickUrl+thisBean.nid+'&channel=webimagezoom&event=sitemtop">同款最低价'+parseFloat(thisBean.view_price)+'元</a>');element.find(".lxtbctip").css("border","1px solid #FF4400");}}catch(err){}}});}
chrome.extension.sendRequest({type:'weburl',dataType:"json",url:"http://api.dataoke.com/index.php?r=port/index&appkey=gfyeo1mdv7&v=2&id="+itemid},function(response){try{var quanDetail=response.data.result;var zyQuanStr=quanDetail.Quan_id;if(zyQuanStr!=undefined){var hasDouhao="";if(element.find(".lxtbctip_similar").length>0){hasDouhao="&nbsp，&nbsp";}
element.find(".lxtbctip").css("border","1px solid #FF4400");element.find(".lxtbctip").append(hasDouhao+'<a target="_blank" class="lxtbctip_quan" href="javascript:void(0);" data_url="'+quanDetailUrl+"?activityId="+zyQuanStr+"&itemId="+itemid+'activity_id='+zyQuanStr+'&seller_id='+sellerId+'&channel=webimagezoom&event=sitemtop">有立减券'+parseFloat(quanDetail.Quan_price)+'元</a>');}}catch(err){}
if(element.find(".lxtbctip_quan").length<=0){var quanList=new Array();var isLogin=false;chrome.extension.sendRequest({type:'weburl',dataType:"json",url:"https://cart.taobao.com/json/GetPriceVolume.do?sellerId="+sellerId},function(response){if(response.msg=="ok"){isLogin=true;var trItems="";var cartDataList=response.data.priceVolumes;for(var i=0;i<cartDataList.length;i++){quanList.push(cartDataList[i].id);}}
if(quanList.length>0){var hasDouhao="";if(element.find(".lxtbctip_similar").length>0){hasDouhao="&nbsp，&nbsp";}
element.find(".lxtbctip").css("border","1px solid #FF4400");element.find(".lxtbctip").append(hasDouhao+'<a target="_blank" class="lxtbctip_quan" href="javascript:void(0);" data_url="'+sclickUrl+itemid+'&channel=webimagezoom&event=sitemtop">发现'+quanList.length+'张券</a>');}});}});};function getRateData(element,itemid){chrome.extension.sendRequest({type:'weburl',dataType:"text",url:"https://rate.taobao.com/feedRateList.htm?rateType=3&auctionNumId="+itemid+"&currentPageNum=1&orderType=feedbackdate"},function(response){var dataStr=response.data.trim();dataStr=dataStr.substring(1,dataStr.length-1);var dataJson=JSON.parse(dataStr);if(dataJson.total>0){var imgHtml="";var hasImgCount=0;for(var i in dataJson.comments){if(hasImgCount>9){break;}
var thisComment=dataJson.comments[i];for(var j in thisComment.photos){if(hasImgCount>9){break;}
var thisPhoto=thisComment.photos[j];imgHtml+="<img title='"+thisComment.content+"' src='http:"+thisPhoto.thumbnail+"'/>";hasImgCount++;}
if(thisComment.append!=null){for(var k in thisComment.append.photos){if(hasImgCount>9){break;}
var thisPhoto=thisComment.append.photos[k];imgHtml+="<img title='"+thisComment.append.content+"' src='http:"+thisPhoto.thumbnail+"'/>";hasImgCount++;}}}
element.find(".lxRateImgParent").prepend('<div href="javascript:void(0);" data_url="'+sclickUrl+itemid+'&channel=webimagezoom&event=sitemtop" class="lxRateImgBigHover"><a style="position:absolute;" target="_blank" class="lxRateImgBigHoverLink" href="http://www.jingzhewang.com/mjx/?id='+itemid+'">查看高清图</a></div><a target="_blank" href="javascript:void(0);" data_url="'+sclickUrl+itemid+'&channel=webimagezoom&event=sitemtop" class="lxRateImgContent">'+imgHtml+'</a>');}});}
function getQdthumbnailImgUrl(url){try{var beginStr=url.match(/(\S*).com/)[1];var endStr=url.match(/jfs(\S*)/)[1];return beginStr+".com/n9/s40x40_jfs"+endStr;}catch(err){}
return url;}
function getQdRateData(element,itemid){if(element.find(".lxRateImgParent").length<=0){chrome.extension.sendRequest({type:'weburl',dataType:"JSON",url:"https://club.jd.com/discussion/getProductPageImageCommentList.action?productId="+itemid+"&isShadowSku=0&page=1&pageSize=10"},function(response){if(response.data.imgComments.imgCommentCount>0){var imgHtml="";var hasImgCount=0;for(var i in response.data.imgComments.imgList){if(i>10){break;}
var thisComment=response.data.imgComments.imgList[i];imgHtml+="<img title='"+thisComment.commentVo.content+"' src='http:"+getQdthumbnailImgUrl(thisComment.imageUrl)+"'/>";}
element.find(".p-img").prepend('<div style="position:absolute" class="lxRateImgParent"><div style="position: absolute;top:-310px;" href="javascript:void(0);" data_url="'+sclickUrl+itemid+'&channel=webimagezoom&event=sitemtop" class="lxRateImgBigHover"><a style="position:absolute;" target="_blank" class="lxRateImgBigHoverLink" href="http://www.jingzhewang.com/mjx/jd?id='+itemid+'">查看高清图</a></div><a style="position: absolute;top:0px; width: 220px;" target="_blank" href="'+qdclickUrl+itemid+'.html?channel=webimagezoom&event=sitemtop" class="lxRateImgContent">'+imgHtml+'</a></div>');}});}}
$(function(){if(isShow){if(window.location.href.indexOf("s.taobao.com")>-1){$("body").delegate(".m-itemlist .item","mouseenter",function(){if($(this).find(".lxRateImgParent").length<=0){$(this).find(".pic-box").prepend('<div class="lxRateImgParent"></div>');if($(this).find(".pic-link").length>0){var dataA=$(this).find("a.shopname");var itemid=dataA.attr("data-nid");var sellerid=dataA.attr("data-userid");var uniqpid=getQueryStringByUrl($(this).find(".similars a:nth-child(2)").attr("href"),"uniqpid");var title=$(this).find(".ctx-box .J_ClickStat").text();if($(this).find(".lxtbctip").length<=0){getQuanArrayStr2($(this),itemid,sellerid,uniqpid,title);}};}});$("body").delegate(".m-itemlist .item","mouseleave",function(){$(".m-itemlist .item .lxRateTipParent").hide();});$("body").delegate(".m-itemlist .item","click",function(){var picA=$(this).find(".J_ClickStat");var imgA=$(this).find(".pic-link");var uniqpid=picA.attr("trace-pid");var orginItemUrl=picA.attr("href");picA.attr("href",orginItemUrl+"&uniqpid="+uniqpid);imgA.attr("href",orginItemUrl+"&uniqpid="+uniqpid);});$("body").delegate(".lxRateImgParent .lxRateImgContent img","mouseenter",function(){var imgUrl=$(this).attr("src").replace("40x40","300x300");$(this).parents(".lxRateImgParent").find(".lxRateImgBigHover").css("background-image","url("+imgUrl+")");});$("body").delegate(".lxtbctip a","click",function(){var url=$(this).attr('data_url');chrome.extension.sendRequest({type:'tabnew',url:url},function(response){});});}else{$("body").delegate("#J_goodsList .gl-item","mouseenter",function(){var itemId=$(this).find(".J_focus").attr("data-sku");getQdRateData($(this),itemId);});$("body").delegate(".lxRateImgParent .lxRateImgContent img","mouseenter",function(){var imgUrl=$(this).attr("src").replace("40x40","300x300");$(this).parents(".lxRateImgParent").find(".lxRateImgBigHover").css("background-image","url("+imgUrl+")");});}}});