({itemId:"",mostLijianValue:0,sclickUrl:"http://item.taobao.com/item.htm?id=",alClickUrl:"http://item.taobao.com/item.htm?id=",quanDetailUrl:"https://market.m.taobao.com/apps/aliyx/coupon/detail.html",isShow:false,execute:function(){saleHtml="";priceHtml="";_this=this;chrome.storage.local.get(['shopConfig'],function(valueArray){if(valueArray.shopConfig!=undefined){var shopConfigJson=eval("("+valueArray.shopConfig+")");if(shopConfigJson.alClickUrl!=undefined){_this.alClickUrl=shopConfigJson.alClickUrl;_this.isShow=true;}
if(shopConfigJson.sclickUrl!=undefined){_this.sclickUrl=shopConfigJson.sclickUrl;}
if(shopConfigJson.quanDetailUrl!=undefined){_this.quanDetailUrl=shopConfigJson.quanDetailUrl;}
if(shopConfigJson.containPid!=undefined){var currpid=getQueryString("ali_trackid");if(currpid!=null){var containPidList=shopConfigJson.containPid.split(";");for(var i=0;i<containPidList.length;i++){if(currpid.indexOf(containPidList[i])>-1){var newLocation=window.location.href.replace(currpid,"2:"+shopConfigJson.pushPid);window.history.pushState({},0,newLocation);break;}}}}}});_this.itemId=_this.getQueryString("id");$(function(){window.addEventListener('message',function(e){if(e.origin.indexOf("uland.taobao.com")>0){var thisItem=$("#STquanContent #"+e.data.couponKey);thisItem.attr("class","checked");if(e.data.quanState==2){thisItem.text("立减"+e.data.quanPrice+"元");thisItem.addClass("lxlijianjuanA");if(e.data.quanPrice>_this.mostLijianValue){_this.mostLijianValue=e.data.quanPrice;$("#STTipQuan2").html("【有立减券"+e.data.quanPrice+"元】");}}else{thisItem.html(e.data.quanText);}
if($("#STquanContent .lxQuanUnCheck .checked").length<10){var quanKey=$("#STquanContent .lxQuanUnCheck .uncheck:first-child").attr("id");if(quanKey!=undefined&&quanKey!=""&&quanKey!=null){var checkQuanUrl='https://uland.taobao.com/coupon/edetail?itemId='+_this.itemId+'&activityId='+quanKey+'&lxjuancx=true';setTimeout(function(){$("#lxQuanCheckIframe").attr("src",checkQuanUrl);},1000);}else{_this.saveCurrentData();}}else{_this.saveCurrentData();}}});if(_this.isShow){_this.insertHtml();}
$("#lxSortBySale").click(function(){$("#lxSortBySale").css({"background-color":"#ED145B","color":"#FFFFFF"});$("#lxSortByPrice").css({"background-color":"#fff","color":"#333333"});$("#lxSimilarTable #saleHtml").show();$("#lxSimilarTable #priceHtml").hide();});$("#lxSortByPrice").click(function(){$("#lxSortBySale").css({"background-color":"#fff","color":"#333333"});$("#lxSortByPrice").css({"background-color":"#ED145B","color":"#FFFFFF"});$("#lxSimilarTable #priceHtml").show();$("#lxSimilarTable #saleHtml").hide();});$("#lxSTDataRefresh").click(function(e){localStorage.removeItem("lxCouponTipHtml115"+_this.itemId);window.location.href=_this.sclickUrl+_this.itemId+"&channel=webimagezoom&event=detailrefresh";});$('#bijiaTable table').delegate('a','click',function(){var url=$(this).attr('data_url');chrome.extension.sendRequest({type:'tabnew',url:url},function(response){});});$('#bijiaTable #STquanContent').delegate('a','click',function(){var url=$(this).attr('data_url');chrome.extension.sendRequest({type:'tabupdate',url:url},function(response){});});});window.onload=function(){if(_this.getCookie('login')=="true"&&$("#STCouponTipParent #lxnologin").length>0){$("#STCouponTipParent #lxnologin").remove();_this.getQuanArrayStr(_this.getSellerId(),_this.itemId);}
if($("#saleHtml tr").length<1){localStorage.removeItem('lxCouponTipHtml115'+_this.itemId);}}},getCookie:function(name){var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");if(arr=document.cookie.match(reg))
return unescape(arr[2]);else
return null;},saveCurrentData:function(){var currnetStamp=new Date().getTime();var cloneTip=$('#STCouponTipParent').clone();cloneTip.find("#lxQuanCheckIframe").remove();var htmlStr=cloneTip.prop("outerHTML");try{localStorage.setItem("lxCouponTipHtml115"+_this.itemId,currnetStamp+htmlStr);}catch(oException){if(oException.name=='QuotaExceededError'){localStorage.clear();localStorage.setItem("lxCouponTipHtml115"+_this.itemId,currnetStamp+htmlStr);}}},getQueryString:function(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var myUrl=window.location.href.substring(window.location.href.indexOf("?")+1);var r=myUrl.match(reg);if(r!=null){if(r[2]!=""){return decodeURIComponent(r[2]);}}
return null;},getQueryStringByUrl:function(url,name){var myUrl=url.substring(url.indexOf("?")+1);var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=myUrl.match(reg);if(r!=null){if(r[2]!=""){return decodeURIComponent(r[2]);}}
return null;},insertHtml:function(){if($("#STCouponTipParent").length<=0){var isFromeLocal=false;var containHtml='<div id="STCouponTipParent"><iframe id="lxQuanCheckIframe" style="display:none;width:0px;height:0px;"></iframe><div id="bijiaTip"><div id="lxSTDataRefresh" title="重新加载数据"></div><a id="STbijiaTipA" target="_blank"><span id="STSameNumTip">正在查询中…</span><font id="STSameLow" size="0.7"></font><font id="STTipQuan" size="0.7"></font><font id="STTipQuan2" size="0.7"></font></a></div><div id="bijiaTable"><ul id="STquanContent"><span class="lxQuanLijian"></span><span class="lxQuanManjian"></span><span class="lxQuanUnCheck"></span><span class="lxQuanUnknow"></span><span class="lxQuanInvalid"></span></ul><table id="lxSortTable" width="100%" cellpadding="0" cellspacing="0"><tr><td id="lxSortBySale" class="lxSortChoose">销量排序<br/><font size="-2"></font></td><td id="lxSortByPrice">价格排序<br/><font size="-2"></font></td><td></td></tr></table><table id="lxSimilarTable"><tbody id="saleHtml"></tbody><tbody id="priceHtml" style="display:none"></tbody></table></div></div>';var cacheHtml=localStorage.getItem("lxCouponTipHtml115"+_this.itemId);if(cacheHtml!=null&&cacheHtml!=""){var localStamp=cacheHtml.substring(0,13);if(new Date().getTime()-localStamp<43200000){containHtml=cacheHtml.substring(13);isFromeLocal=true;}}
if(window.location.href.indexOf("detail.tmall.com")>-1||window.location.href.indexOf("detail.tmall.hk")>-1||window.location.href.indexOf("detail.yao.95095.com")>-1){$(".tb-meta").append(containHtml);}else if(window.location.href.indexOf("item.taobao.com")>-1){$("ul.tb-meta").after(containHtml);}else{$("body").prepend(containHtml);}
if(!isFromeLocal){var sellerId=_this.getSellerId();var titleAll=document.title;var title=titleAll.substring(0,titleAll.indexOf("-"));var uniqpid=_this.getQueryString("uniqpid");if(uniqpid==null){chrome.extension.sendRequest({type:'weburl',dataType:"json",url:"http://pub.alimama.com/items/search.json?q=https%3A%2F%2Fitem.taobao.com%2Fitem.htm%3Fid%3D"+_this.itemId},function(response){try{uniqpid=response.data.data.pageList[0].sameItemPid;}catch(err){uniqpid="";}
_this.getSameStyleArray(uniqpid);});}else{_this.getSameStyleArray(uniqpid);}
_this.getQuanArrayStr(sellerId,_this.itemId);}}},getSellerId:function(){var url=window.location.href;if(url.indexOf('detail.ju.taobao.com')!=-1){return $('.J_RightRecommend').attr('data-sellerid');}else if(url.indexOf('chaoshi.detail.tmall.com')!=-1){var d=$("#J_SellerInfo").attr("data-url");var e=d.match(/user_num_id=(\d+)/g);var f=String(e).split("=");return f[1];}else if(url.indexOf('world.taobao.com')!=-1){var d=$("#J_listBuyerOnView").attr("data-api");var e=d.match(/seller_num_id=(\d+)/g);var f=String(e).split("=");return f[1];}else{var meta=$('meta[name=microscope-data]').attr('content');if(meta){var userid=/userid=(\d+)/.exec(meta)[1];return userid;}}},getSameStyleArray:function(samePid){if(samePid.indexOf("-")>-1){var similarUrl="https://s.taobao.com/search?type=samestyle&app=i2i&rec_type=1&uniqpid="+samePid+"&nid="+_this.itemId+"&sort=sale-desc";chrome.extension.sendRequest({type:'weburl',dataType:"text",url:similarUrl},function(response){try{var beginCut=response.data.indexOf("g_page_config")+16;var endCut=response.data.indexOf("g_srp_loadCss();");if(beginCut>0){var similarListStr=response.data.substring(beginCut,endCut).trim();similarListStr=similarListStr.substring(0,similarListStr.length-1);var similarJson=JSON.parse(similarListStr);var similarList=similarJson.mods.recitem.data.items;if(similarList.length>2){$("#STSameNumTip").html("找到"+similarList.length+"个同款");for(var i=0;i<similarList.length;i++){var thisBean=similarList[i];var isTmall="";if(thisBean.detail_url.indexOf("detail.tmall.com")>-1){isTmall="<img src='https://gw.alicdn.com/tps/TB10U2vKFXXXXa3XXXXXXXXXXXX-36-36.png_20x20.jpg'/>";}
if(thisBean.nid==_this.itemId){isTmall="本页宝贝";}
if(i==0){$("#lxSortBySale font").html("最高"+thisBean.view_sales)}
var trItemSame='<tr><td width="14%" rowspan="2" class="lxSimilarImage"><a target="_blank" href="javascript:void(0);" data_url="'+_this.alClickUrl+thisBean.nid+'&channel=webimagezoom&event=detailtitem"><img src="'+thisBean.pic_url+'_80x80.jpg" /></a></td><td width="45%" class="lxSimilarTitle"><a target="_blank" href="javascript:void(0);" data_url="'+_this.alClickUrl+thisBean.nid+'&channel=webimagezoom&event=detailtitem">'+thisBean.title+'</a></td><td width="25%" class="lxSimilarSale">'+thisBean.view_sales+'</td><td width="16%" class="lxSimilarPrice">￥'+thisBean.view_price+'</td></tr><tr><td class="lxSimilarShop">'+thisBean.nick+'</td><td class="lxSimilarLocation">'+thisBean.item_loc+'</td><td class="lxSimilarType" align="center">'+isTmall+'</td></tr>';saleHtml+=trItemSame;}
$("#lxSimilarTable #saleHtml").html(saleHtml);similarList.sort(function(a,b){return a.view_price-b.view_price});for(var i=0;i<similarList.length;i++){var thisBean=similarList[i];var isTmall="";if(thisBean.detail_url.indexOf("detail.tmall.com")>-1){isTmall="<img src='https://gw.alicdn.com/tps/TB10U2vKFXXXXa3XXXXXXXXXXXX-36-36.png_20x20.jpg'/>";}
if(thisBean.nid==_this.itemId){isTmall="本页宝贝";}
if(i==0){$("#lxSortByPrice font").html("最低￥"+thisBean.view_price);$("#STbijiaTipA #STSameLow").html("(最低"+parseFloat(thisBean.view_price)+"元)")}
var trItemSame='<tr><td width="14%" rowspan="2" class="lxSimilarImage"><a target="_blank" href="javascript:void(0);" data_url="'+_this.alClickUrl+thisBean.nid+'&channel=webimagezoom&event=detailtitem"><img src="'+thisBean.pic_url+'_80x80.jpg" /></a></td><td width="45%" class="lxSimilarTitle"><a target="_blank" href="javascript:void(0);" data_url="'+_this.alClickUrl+thisBean.nid+'&channel=webimagezoom&event=detailtitem">'+thisBean.title+'</a></td><td width="25%" class="lxSimilarSale">'+thisBean.view_sales+'</td><td width="16%" class="lxSimilarPrice">￥'+thisBean.view_price+'</td></tr><tr><td class="lxSimilarShop">'+thisBean.nick+'</td><td class="lxSimilarLocation">'+thisBean.item_loc+'</td><td class="lxSimilarType" align="center">'+isTmall+'</td></tr>';priceHtml+=trItemSame;}
$("#lxSimilarTable #priceHtml").html(priceHtml);_this.saveCurrentData();}else{_this.getSameNameArray();}}else{_this.getSameNameArray();}}catch(err){_this.getSameNameArray();}});}else{_this.getSameNameArray();}},getSameNameArray:function(){var zhuImgUrl=$("#J_UlThumb li:first-child img").attr("src");var urlBegin=zhuImgUrl.lastIndexOf("/");if(urlBegin>0){zhuImgUrl=zhuImgUrl.substring(urlBegin+1);var urlEnd=zhuImgUrl.indexOf(".jpg");if(urlEnd>0){zhuImgUrl=zhuImgUrl.substring(0,urlEnd+4);}
urlEnd=zhuImgUrl.indexOf(".png");if(urlEnd>0){zhuImgUrl=zhuImgUrl.substring(0,urlEnd+4);}
urlEnd=zhuImgUrl.indexOf(".gif");if(urlEnd>0){zhuImgUrl=zhuImgUrl.substring(0,urlEnd+4);}}
chrome.extension.sendRequest({type:'weburl',dataType:"text",url:"https://s.taobao.com/search?app=imgsearch&tfsid="+encodeURI(zhuImgUrl)},function(response){try{if(response.data!=null){var beginCut=response.data.indexOf("g_page_config =");if(beginCut>0){var cutBeginStr=response.data.substring(beginCut+15);var endCut=cutBeginStr.indexOf("};");var similarListStr=cutBeginStr.substring(0,endCut+1).trim();var similarJson=JSON.parse(similarListStr);var similarList=similarJson.mods.itemlist.data.collections[0].auctions;if(similarList.length>0){$("#STSameNumTip").html("找到"+similarList.length+"个相似");similarList.sort(function(a,b){var aValue=a.view_sales.replace("人付款","");var bValue=b.view_sales.replace("人付款","");return bValue-aValue});for(var i=0;i<similarList.length;i++){var thisBean=similarList[i];var isTmall="";if(thisBean.detail_url.indexOf("detail.tmall.com/")>-1){isTmall="<img src='https://gw.alicdn.com/tps/TB10U2vKFXXXXa3XXXXXXXXXXXX-36-36.png_20x20.jpg'/>";}
if(thisBean.nid==_this.itemId){isTmall="本页宝贝";}
if(i==0){$("#lxSortBySale font").html("最高"+thisBean.view_sales);}
var trItemSame='<tr><td width="14%" rowspan="2" class="lxSimilarImage"><a target="_blank" href="javascript:void(0);" data_url="'+_this.alClickUrl+thisBean.nid+'&channel=webimagezoom&event=detailtitem"><img src="'+thisBean.pic_url+'_80x80.jpg" /></a></td><td width="45%" class="lxSimilarTitle"><a target="_blank" href="javascript:void(0);" data_url="'+_this.alClickUrl+thisBean.nid+'&channel=webimagezoom&event=detailtitem">'+thisBean.title+'</a></td><td width="25%" class="lxSimilarSale">'+thisBean.view_sales+'</td><td width="16%" class="lxSimilarPrice">￥'+thisBean.view_price+'</td></tr><tr><td class="lxSimilarShop">'+thisBean.nick+'</td><td class="lxSimilarLocation">'+thisBean.item_loc+'</td><td class="lxSimilarType" align="center">'+isTmall+'</td></tr>';saleHtml+=trItemSame;}
$("#lxSimilarTable #saleHtml").html(saleHtml);similarList.sort(function(a,b){return a.view_price-b.view_price});for(var i=0;i<similarList.length;i++){var thisBean=similarList[i];var isTmall="";if(thisBean.detail_url.indexOf("detail.tmall.com/")>-1){isTmall="<img src='https://gw.alicdn.com/tps/TB10U2vKFXXXXa3XXXXXXXXXXXX-36-36.png_20x20.jpg'/>";}
if(thisBean.nid==_this.itemId){isTmall="本页宝贝";}
if(i==0){$("#lxSortByPrice font").html("最低￥"+thisBean.view_price);$("#STbijiaTipA #STSameLow").html("(最低"+parseFloat(thisBean.view_price)+"元)")}
var trItemSame='<tr><td width="14%" rowspan="2" class="lxSimilarImage"><a target="_blank" href="javascript:void(0);" data_url="'+_this.alClickUrl+thisBean.nid+'&channel=webimagezoom&event=detailtitem"><img src="'+thisBean.pic_url+'_80x80.jpg" /></a></td><td width="45%" class="lxSimilarTitle"><a target="_blank" href="javascript:void(0);" data_url="'+_this.alClickUrl+thisBean.nid+'&channel=webimagezoom&event=detailtitem">'+thisBean.title+'</a></td><td width="25%" class="lxSimilarSale">'+thisBean.view_sales+'</td><td width="16%" class="lxSimilarPrice">￥'+thisBean.view_price+'</td></tr><tr><td class="lxSimilarShop">'+thisBean.nick+'</td><td class="lxSimilarLocation">'+thisBean.item_loc+'</td><td class="lxSimilarType" align="center">'+isTmall+'</td></tr>';priceHtml+=trItemSame;}
$("#lxSimilarTable #priceHtml").html(priceHtml);}else{$("#STSameNumTip").html("未找到同款");}}else{$("#STSameNumTip").html("未找到同款");}}else{$("#STSameNumTip").html("未找到同款");}}catch(err){$("#STSameNumTip").html("未找到同款");}
_this.saveCurrentData();});},getQuanArrayStr:function(sellerId,itemid){quanList=new Array();isLogin=false;chrome.extension.sendRequest({type:'weburl',dataType:"json",url:"https://cart.taobao.com/json/GetPriceVolume.do?sellerId="+sellerId},function(response){if(response.msg=="ok"){isLogin=true;var trItems="";var cartDataList=response.data.priceVolumes;for(var i=0;i<cartDataList.length;i++){quanList.push(cartDataList[i].id);var getQuanUrl=_this.quanDetailUrl+"?activityId="+cartDataList[i].id+"&itemId="+_this.itemId+"&activity_id="+cartDataList[i].id+"&seller_id="+sellerId+"&channel=webimagezoom&event=detailt";trItems+='<li><a  href="javascript:void(0);" data_url="'+getQuanUrl+'">'+cartDataList[i].condition.replace("减","减<strong>")+'</strong></a></li>';}
$("#STTipQuan").html("…"+quanList.length+"张券");$("#STquanContent .lxQuanManjian").append(trItems);}else{$("#STCouponTipParent").prepend('<span id="lxnologin"></span>');}
chrome.extension.sendRequest({type:'weburl',dataType:"json",url:"http://zhushou4.taokezhushou.com/api/v1/material_info?item_url=https%3A%2F%2Fitem.taobao.com%2Fitem.htm%3Fid%3D"+_this.itemId},function(response){if(response.data!=null){try{var zyQuanStr=response.data.data.coupon_id;if($.inArray(zyQuanStr,quanList)<0){quanList.unshift(zyQuanStr);var quanPrice=response.data.data.coupon_info.replace(".00元","");var getQuanUrl=_this.quanDetailUrl+"?activityId="+zyQuanStr+"&itemId="+_this.itemId+"&activity_id="+zyQuanStr+"&seller_id="+sellerId+"&channel=webimagezoom&event=detailt";var trItem='<li><a class="lxlijianjuanA" id="'+zyQuanStr+'" href="javascript:void(0);" data_url="'+getQuanUrl+'">'+quanPrice+'</a></li>';$("#STquanContent").prepend(trItem);$("#STTipQuan").html("…"+quanList.length+"张券");$("#STTipQuan2").html("【有立减券】");}}catch(err){}}
chrome.extension.sendRequest({type:'weburl',dataType:"json",url:"http://api.dataoke.com/index.php?r=port/index&appkey=eiyoxwxj0e&v=2&id="+_this.itemId},function(response){if(response.data!=null){try{var quanDetail=response.data.result;var zyQuanStr=quanDetail.Quan_id;if(zyQuanStr!=undefined){quanList.unshift(zyQuanStr);var getQuanUrl=_this.quanDetailUrl+"?activityId="+zyQuanStr+"&itemId="+_this.itemId+"&activity_id="+zyQuanStr+"&seller_id="+sellerId+"&channel=webimagezoom&event=detailt";var quanPrice=parseFloat(quanDetail.Quan_price);var trItem='<li><a class="lxlijianjuanA" href="javascript:void(0);" data_url="'+getQuanUrl+'">立减<strong>'+quanPrice+'</strong>元</a></li>';$("#STquanContent").prepend(trItem);$("#STTipQuan").html("…"+quanList.length+"张券");if(quanPrice>_this.mostLijianValue){_this.mostLijianValue=quanPrice;$("#STTipQuan2").html("【有立减券"+quanPrice+"元】");}}
_this.saveCurrentData();}catch(err){_this.saveCurrentData();}}else{_this.saveCurrentData();}});});});}}).execute();