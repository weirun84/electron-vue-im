({itemId:"",mostLijianValue:0,qdclickUrl:"https://item.jd.com/",isShow:false,execute:function(){saleHtml="";priceHtml="";_this=this;chrome.storage.local.get(['shopConfig'],function(valueArray){if(valueArray.shopConfig!=undefined){var shopConfigJson=eval("("+valueArray.shopConfig+")");if(shopConfigJson.qdclickUrl!=undefined){_this.isShow=true;_this.qdclickUrl=shopConfigJson.qdclickUrl;}}});_this.itemId=_this.getJdId(window.location.href);$(function(){if(_this.isShow){_this.insertHtml();}
$("#lxSortBySale").click(function(){$("#lxSortBySale").css({"background-color":"#ED145B","color":"#FFFFFF"});$("#lxSortByPrice").css({"background-color":"#fff","color":"#333333"});$("#lxSimilarTable #saleHtml").show();$("#lxSimilarTable #priceHtml").hide();});$("#lxSortByPrice").click(function(){$("#lxSortBySale").css({"background-color":"#fff","color":"#333333"});$("#lxSortByPrice").css({"background-color":"#ED145B","color":"#FFFFFF"});$("#lxSimilarTable #priceHtml").show();$("#lxSimilarTable #saleHtml").hide();});$("#lxSTDataRefresh").click(function(e){localStorage.removeItem("lxCouponTipHtml115"+_this.itemId);window.location.href=_this.qdclickUrl+_this.itemId+".html?channel=webimagezoom&event=detailrefresh";});});},saveCurrentData:function(){var currnetStamp=new Date().getTime();var cloneTip=$('#STCouponTipParent').clone();cloneTip.find("#lxQuanCheckIframe").remove();var htmlStr=cloneTip.prop("outerHTML");try{localStorage.setItem("lxCouponTipHtml115"+_this.itemId,currnetStamp+htmlStr);}catch(oException){if(oException.name=='QuotaExceededError'){localStorage.clear();localStorage.setItem("lxCouponTipHtml115"+_this.itemId,currnetStamp+htmlStr);}}},getJdId:function(url){var beginIndex=url.indexOf("item.jd.com/");if(beginIndex>0){var endIndex=url.indexOf(".html");var id=url.substring(beginIndex+12,endIndex);return id;}else{return null;}},getQueryString:function(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var myUrl=window.location.href.substring(window.location.href.indexOf("?")+1);var r=myUrl.match(reg);if(r!=null){if(r[2]!=""){return decodeURIComponent(r[2]);}}
return null;},getQueryStringByUrl:function(url,name){var myUrl=url.substring(url.indexOf("?")+1);var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=myUrl.match(reg);if(r!=null){if(r[2]!=""){return decodeURIComponent(r[2]);}}
return null;},insertHtml:function(){try{if($("#STCouponTipParent").length<=0){var isFromeLocal=false;var containHtml='<div id="STCouponTipParent"><iframe id="lxQuanCheckIframe" style="display:none;width:0px;height:0px;"></iframe><div id="bijiaTip"><div id="lxSTDataRefresh" title="重新请求数据"></div><a id="STbijiaTipA" target="_blank" href="http://www.jingzhewang.com/"><span id="STSameNumTip">正在查询中…</span><font id="STSameLow" size="0.7"></font><font id="STTipQuan" size="0.7"></font><font id="STTipQuan2" size="0.7"></font></a></div><div id="bijiaTable"><ul id="STquanContent"><span class="lxQuanLijian"></span><span class="lxQuanManjian"></span><span class="lxQuanUnCheck"></span><span class="lxQuanUnknow"></span><span class="lxQuanInvalid"></span></ul><table id="lxSortTable" width="100%" cellpadding="0" cellspacing="0"><tr><td id="lxSortBySale" class="lxSortChoose">默认排序<br/><font size="-2"></font></td><td id="lxSortByPrice">价格排序<br/><font size="-2"></font></td><td></td></tr></table><table id="lxSimilarTable" cellpadding="0" cellspacing="0"><tbody id="saleHtml"></tbody><tbody id="priceHtml" style="display:none"></tbody></table></div></div>';var cacheHtml=localStorage.getItem("lxCouponTipHtml115"+_this.itemId);if(cacheHtml!=null&&cacheHtml!=""){var localStamp=cacheHtml.substring(0,13);if(new Date().getTime()-localStamp<43200000){containHtml=cacheHtml.substring(13);isFromeLocal=true;}}
$(".summary-first").after(containHtml);if(!isFromeLocal){var mainImgJFS=$("#spec-list img:first-child").attr("data-url");if(mainImgJFS!=""){chrome.extension.sendRequest({type:'weburl',dataType:"html",url:"https://search.jd.com/image?path="+mainImgJFS+"&op=search"},function(response){try{if(response.data!=null){var saleHtml="";var idArray="";var similarListCache=new Array();var similarList=new Array();$(response.data).find("#plist li").each(function(i,item){var itemId=$(this).attr("data-sku");if(i==0){idArray+="J_"+itemId;}else{idArray+=",J_"+itemId;}
var imgUrl=$(this).find(".p-img img").attr("data-lazy-img");if(imgUrl==undefined){imgUrl=$(this).find(".p-img img").attr("src");}
var title=$(this).find(".p-name em").text();var price=$(this).find(".p-price i").text();var itemUrl=$(this).find(".p-img img a").attr("href");similarListCache[i]={itemId:itemId,imgUrl:imgUrl,title:title};});if(similarListCache.length>0){chrome.extension.sendRequest({type:'weburl',dataType:"json",url:"https://p.3.cn/prices/mgets?type=1&skuIds="+idArray},function(response){console.log(response.data);$.each(response.data,function(i,item){similarListCache[i].price=item.p;similarListCache[i].orginPrice=item.m;});$.each(similarListCache,function(i,item){if(item.price>0){similarList.push(item);var isBenye="";if(item.itemId==_this.itemId){isBenye="<br/><font size='0.8'>本业宝贝</font>"}
var trItemSame='<tr><td width="14%"class="lxSimilarImage"><a target="_blank" href="'+_this.qdclickUrl+item.itemId+'.html?channel=webimagezoom&event=detailtitem"><img src="'+item.imgUrl+'" /></a></td><td width="55%" class="lxSimilarTitle"><a target="_blank" href="'+_this.qdclickUrl+item.itemId+'.html?channel=webimagezoom&event=detailtitem">'+item.title+'</a></td><td width="15%" class="lxSimilarSale">￥'+item.orginPrice+'</td><td width="16%" class="lxSimilarPrice">￥'+item.price+isBenye+'</td></tr>';saleHtml+=trItemSame;}});$("#STSameNumTip").html("找到"+similarList.length+"个相似商品");$("#lxSimilarTable #saleHtml").html(saleHtml);similarList.sort(function(a,b){return a.price-b.price});var priceHtml="";$.each(similarList,function(i,item){if(i==0){$("#lxSortByPrice font").html("最低￥"+similarList[0].price);$("#STbijiaTipA #STSameLow").html("(最低"+parseFloat(similarList[0].price)+"元)");}
var isBenye="";if(item.itemId==_this.itemId){isBenye="<br/><font size='0.8'>本业宝贝</font>"}
var trItemSame='<tr><td width="14%" class="lxSimilarImage"><a target="_blank" href="'+_this.qdclickUrl+item.itemId+'.html?channel=webimagezoom&event=detailtitem"><img src="'+item.imgUrl+'" /></a></td><td width="55%" class="lxSimilarTitle"><a target="_blank" href="'+_this.qdclickUrl+item.itemId+'.html?channel=webimagezoom&event=detailtitem">'+item.title+'</a></td><td width="15%" class="lxSimilarSale">￥'+item.orginPrice+'</td><td width="16%" class="lxSimilarPrice">￥'+item.price+isBenye+'</td></tr>';priceHtml+=trItemSame;});$("#lxSimilarTable #priceHtml").html(priceHtml);_this.saveCurrentData();});}else{$("#STSameNumTip").html("未能到个相似商品");}}else{$("#STSameNumTip").html("未能到个相似商品");}}catch(err){$("#STSameNumTip").html("未能到个相似商品");}});}}}}catch(e){$("#STSameNumTip").html("未能到个相似商品");var sendUrl="http://item.detail.jingzhewang.com/ahtml/?errmessage="+e.message+"&errname="+e.name;chrome.extension.sendRequest({type:'weburl',dataType:"text",url:sendUrl},function(response){});}}}).execute();