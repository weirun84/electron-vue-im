isShowBtn=false;function getQueryString(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=window.location.search.substr(1).match(reg);if(r!=null)
return unescape(r[2]);return null;};function getQueryStringByUrl(url,name){var myUrl=url.substring(url.indexOf("?")+1);var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=myUrl.match(reg);if(r!=null)
return unescape(r[2]);else
return"";};chrome.storage.local.get(['shopConfig','isShowBtn'],function(valueArray){if(valueArray.isShowBtn!=undefined){isShowBtn=valueArray.isShowBtn;}});$(function(){var tempHtml='<div id="lxZoomMask"><div id="lxBackBg"></div><a id="lxTopLink" href="#" target="_blank"></a><div id="lxClose"></div><img id="lxZoomImg" src="img/tibet-1.jpg"/><div id="lxTool"> <div id="lxToolBig" class="lxToolItem" title="放大"></div> <div id="lxToolSmall" class="lxToolItem" title="缩小"></div> <div id="lxToolDownLoad" class="lxToolItem" title="下载"></div><div id="lxToolRotate" class="lxToolItem" title="旋转"></div> <div id="lxToolRefre" class="lxToolItem" title="还原"></div></div><div id="lxSwitchLeft"></div><div id="lxSwitchRight"></div><div id="lxImgInfo"></div></div>';$("body").append(tempHtml);thisImg=$("#lxZoomImg");orginImgWidth=thisImg[0].naturalWidth;orginImgHeight=thisImg[0].naturalHeight;currentImgIndex=0;function initializeImg(){var w=orginImgWidth,h=orginImgHeight,cW=document.documentElement.clientWidth,cH=document.documentElement.clientHeight;var left=(cW-w)/2,top=(cH-h)/2;thisImg.width(orginImgWidth+"px").height(orginImgHeight+"px").css("left",left+"px").css("top",top+"px");thisImg.css("transform","");$("#lxImgInfo").html(orginImgWidth+"x"+orginImgHeight+"&nbsp;&nbsp;&nbsp;&nbsp; "+(currentImgIndex+1)+"/"+$("body img").length);$("#lxZoomMask").find(".lxPecentTip").remove();$('<div class="lxPecentTip">100%</div>').appendTo($("#lxZoomMask")).fadeOut(1000);};function addEvent(obj,sType,fn){obj.addEventListener(sType,fn,false);};function removeEvent(obj,sType,fn){obj.removeEventListener(sType,fn,false);};function prEvent(ev){var oEvent=ev||window.event;if(oEvent.preventDefault){oEvent.preventDefault();}
return oEvent;};function zoomImg(clientX,clientY,ratioDelta){var ratioL=(clientX-thisImg[0].offsetLeft)/thisImg[0].offsetWidth,ratioT=(clientY-thisImg[0].offsetTop)/thisImg[0].offsetHeight,w=parseInt(thisImg[0].offsetWidth*ratioDelta),h=parseInt(thisImg[0].offsetHeight*ratioDelta),l=Math.round(clientX-(w*ratioL)),t=Math.round(clientY-(h*ratioT));var percent=(w/orginImgWidth*100).toFixed(0);if(percent>95&&percent<105){percent=100;w=orginImgWidth;h=orginImgHeight;}else if(percent>=3000){percent=3000;w=orginImgWidth*30;h=orginImgHeight*30;}else if(percent<=5){percent=5;w=orginImgWidth/20;h=orginImgHeight/20;}
with(thisImg[0].style){width=w+'px';height=h+'px';left=l+'px';top=t+'px';}
$("#lxZoomMask").find(".lxPecentTip").remove();$('<div class="lxPecentTip">'+percent+'%</div>').appendTo($("#lxZoomMask")).fadeOut(1000);};$("#lxZoomMask")[0].addEventListener("mousewheel",function(e){e.preventDefault();var _delta=parseInt(e.wheelDelta||-e.detail);if(_delta>0){switchLeft();}else{switchRight();}});$("#lxBackBg").click(function(){$("#lxZoomMask").hide();});thisImg[0].addEventListener("mousewheel",function(e){e.preventDefault();e.cancelBubble=true;var _delta=parseInt(e.wheelDelta||-e.detail);if(_delta>0){zoomImg(e.clientX,e.clientY,1.1);}else{zoomImg(e.clientX,e.clientY,0.9);}});var oImg=thisImg[0];(function(){addEvent(oImg,'mousedown',function(ev){var oEvent=prEvent(ev),oParent=oImg.parentNode,disX=oEvent.clientX-oImg.offsetLeft,disY=oEvent.clientY-oImg.offsetTop,startMove=function(ev){if(oParent.setCapture){oParent.setCapture();}
var oEvent=ev||window.event,l=oEvent.clientX-disX,t=oEvent.clientY-disY;oImg.style.left=l+'px';oImg.style.top=t+'px';oParent.onselectstart=function(){return false;}},endMove=function(ev){if(oParent.releaseCapture){oParent.releaseCapture();}
oParent.onselectstart=null;removeEvent(oParent,'mousemove',startMove);removeEvent(oParent,'mouseup',endMove);};addEvent(oParent,'mousemove',startMove);addEvent(oParent,'mouseup',endMove);return false;});})();document.onkeydown=function(e){e=e||window.event;if(e.keyCode){if(e.keyCode==37){switchLeft();}else if(e.keyCode==39){switchRight();}else if(e.keyCode==27){$("#lxZoomMask").hide();}}};function saveImg(){var img=thisImg[0];var alink=document.createElement("a");alink.href=img.src;alink.download=img.src;alink.click();}
function switchLeft(){currentImgIndex--;if(currentImgIndex<0){currentImgIndex=$("body img").length;}
var nextImg=$("body img").eq(currentImgIndex);var url=nextImg.attr("src");thisImg.attr("src",getOrginUrl(url));setItemUrl(nextImg);}
function switchRight(){currentImgIndex++;if(currentImgIndex>$("body img").length){currentImgIndex=0;}
var nextImg=$("body img").eq(currentImgIndex);var url=nextImg.attr("src");thisImg.attr("src",getOrginUrl(url));setItemUrl(nextImg);}
function setItemUrl(currentElement){if(currentElement.parent("a").length>0){var parentA=currentElement.parent("a").eq(0);var parentAUrl=parentA.attr("href");var title=parentA.attr("title");if(title==undefined||title==""){title=currentElement.attr("alt");}
if(title==undefined||title==""){title=currentElement.parents("li").eq(0).text().replace("放大图片","").replace("<","").replace(">","");}
if(title==undefined||title==""){title=(currentImgIndex+1)+"";}
$("#lxTopLink").html(title).attr("href",parentAUrl);}else{$("#lxTopLink").html("");}}
$("#lxClose").click(function(){$("#lxZoomMask").hide();});$("#lxSwitchLeft").click(function(){switchLeft();});$("#lxSwitchRight").click(function(){switchRight();});$("#lxToolBig").click(function(){var x=document.documentElement.clientWidth/2;var y=document.documentElement.clientHeight/2;zoomImg(x,y,1.1);});$("#lxToolSmall").click(function(){var x=document.documentElement.clientWidth/2;var y=document.documentElement.clientHeight/2;zoomImg(x,y,0.9);});$("#lxToolDownLoad").click(function(){saveImg();});$("#lxToolRotate").click(function(){var ratateDeg=90;var ratateDegStr=thisImg[0].style.transform;if(ratateDegStr.indexOf("rotate(")==0&&ratateDegStr.indexOf("rotate(360")<0){ratateDeg=parseInt(ratateDegStr.replace("rotate(","").replace("deg)",""))+90;}
thisImg[0].style.transform='rotate('+ratateDeg+'deg)';});$("#lxToolRefre").click(function(){initializeImg();});thisImg.load(function(){orginImgWidth=thisImg[0].naturalWidth;orginImgHeight=thisImg[0].naturalHeight;initializeImg();});function getOrginUrl(url){if(url.indexOf(".alicdn.com")>0||url.indexOf(".tbcdn.cn")>0||url.indexOf(".taobaocdn.com")>0){if(url.indexOf("cbu0")>=0){var point1Begin=url.lastIndexOf(".");var fileType=url.substring(point1Begin,url.length);var noTypeUrl=url.substring(0,point1Begin);var point2Begin=noTypeUrl.lastIndexOf(".");var point2Begin=noTypeUrl.lastIndexOf(".");var slashBegin=noTypeUrl.lastIndexOf("/");if(point2Begin>slashBegin){var noPointUrl=url.substring(0,point2Begin);return noPointUrl+fileType;}}else{var indexJpg=url.indexOf(".jpg");var indexPng=url.indexOf(".png");if(indexJpg>0&&indexPng<0)
return url.substring(0,indexJpg+4);else if(indexJpg>0&&indexPng>0&&indexJpg>indexPng)
return url.substring(0,indexPng+4);else if(indexJpg>0&&indexPng>0&&indexPng>indexJpg)
return url.substring(0,indexJpg+4);else if(indexJpg<0&&indexPng>0)
return url.substring(0,indexPng+4);}}else if(url.indexOf(".360buyimg.com/")>0){var comBegin=url.indexOf(".360buyimg.com/");var ftsEnd=url.indexOf("jfs/");if(ftsEnd>0){var topUrl=url.substring(0,comBegin+15);var bottomUrl=url.substring(ftsEnd+3,url.length);return topUrl+"imgzone/jfs"+bottomUrl;}}
return url;}
$("body").delegate("img","mouseenter",function(){if($("#lxZoomMask").is(":hidden")){currentImgIndex=$("body img").index(this);}
if(isShowBtn){var Y=$(this).offset().top-$(window).scrollTop()-40;var X=$(this).offset().left;var thisImgUrl=$(this).attr("src");if($(this).parents('#lxZoomMask').length<=0){$("body").find(".lxShowBigTip").remove();$(this).parent().append('<section class="lxShowBigTip" showUrl="'+thisImgUrl+'" style="width: '+$(this).width()+'px;top:'+Y+'px;left: '+X+'px;">放大图片</section>');$(this).parent().bind("mouseleave",function(){$("body").find(".lxShowBigTip").remove();});}}});$("body").delegate(".lxShowBigTip","click",function(e){e.preventDefault();var orginImgUrl=getOrginUrl($(this).attr("showUrl"));thisImg.attr("src",orginImgUrl);$("#lxZoomMask").show();setItemUrl($(this).parent().find("img").eq(0));});chrome.extension.onMessage.addListener(function(request,sender,sendResponse){if(request.type=='RGShowBig'){var originImgUrl=getOrginUrl(request.url);thisImg.attr("src",originImgUrl);$("#lxZoomMask").show();setItemUrl($("body img").eq(currentImgIndex));}});});